<!DOCTYPE html>
<html>
<head>
    <title>Footprint Mobile</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css">
    <link rel="stylesheet" href="css/jquery.datetimepicker.css">
    <link rel="stylesheet" href="/css/swipebox.min.css">
    <link rel="stylesheet" href="/css/footprint-main.css">
</head>
<body>
    <div data-role="page" id="map-page">
        <div data-role="panel" data-display="overlay" id="timeline-panel"> 
            <span>My timeline</span>

            <div id="timeline-slot-listview" data-role="collapsibleset"></div>

            <a href="#pageone" data-rel="close" id="timeline-close" class="ui-btn ui-mini ui-btn-inline ui-shadow ui-corner-all ui-btn-a ui-icon-delete ui-btn-icon-left">Close</a>
        </div>
        <div data-role="header">
            <a href="#" class="ui-btn ui-icon-clock ui-btn-icon-left" id="popup-timeline-panel">&nbsp;</a>
            <h4 id="footprint-ui-title">Footprint World Map</h4>
        </div>
        <div data-role="main" class="ui-content" style="display: none">
            <div data-role="popup" id="create-marker-dialog" data-theme="a" class="ui-corner-all mobile-dialog">
                <div data-role="main" class="ui-content">
                    <h4>Create new marker</h4>
                    <a href="#" data-rel="back" class="ui-btn ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
                    <label for="date" >Date:</label>
                    <input type="text" name="date" id="date" value="" data-theme="a">
                    <!--<label for="brief" >Brief:</label>
                    <input type="text" name="brief" id="brief" value="" data-theme="a">-->
                    <label for="content" >Message:</label>
                    <textarea rows="6" name="content" id="content" value="" data-theme="a"></textarea>
                    <label for="files" >Photo</label>
                    <input id="fileupload" type="file" name="files[]" data-url="/api/uploadImage" multiple>
                    <a id="marker-submit" href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b ui-icon-back ui-btn-icon-left" data-rel="back">Done</a>
                </div>
            </div>
            <div data-role="popup" id="image-gallery-dialog" data-theme="a">
                <div data-role="main" class="ui-content" id="imageGallery">
                    <span id="gallery-brief" style="margin-right:24px;"></span><a href="#" data-rel="back" class="ui-btn ui-corner-all ui-shadow ui-btn-a ui-icon-delete ui-btn-icon-notext ui-btn-right">Close</a>
                    <p id="gallery-content"></p>
                    <div id="gallery-images"></div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
        <div data-role="main" class="full-screen"><div id="map-canvas" class="full-screen"></div></div>
    </div>

    <!--script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDIekX4pNPTLAON4UFXJfI7YAfUVpliAtY"></script-->
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.js"></script>
    <script src="js/jquery.fileupload.js"></script>
    <script src="js/jquery.datetimepicker.js"></script>
    <script src="/js/jquery.swipebox.min.js"></script>
    <script src="/js/ios-orientationchange-fix.js"></script>
    <script src="../js/footprint.js"></script>
    <script type="text/javascript">
        var currentLatitude = 0;
        var currentLongitude = 0;
        var map;
        var galleryDialog;

        function setCurrentLocation(lat, lng) {
            currentLatitude = lat;
            currentLongitude = lng;
        }

        function setDefaultForFields() {
            setCurrentDateTime("#date");
            $("#brief").val("");
            $("#content").val("");
            $(".uploadedImage").remove();
        }

        function drawMap(latlng) {
            var myOptions = {
                zoom: 8,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                disableDoubleClickZoom: true
            };
            map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);

            google.maps.event.addListener(map, 'dblclick', function(event) {
                setCurrentLocation(event.latLng.lat(), event.latLng.lng());
                setDefaultForFields();

                $("#create-marker-dialog").popup("open");
            });

            $.get("/api/get", function(response) {
                var bounds = new google.maps.LatLngBounds();
                $.each(response, function(key, value) {                        
                    if (value.latitude != null && value.longitude != null && value.content != null) {
                        createMarker(map, value.latitude, value.longitude, value.date, value.image, value.content);
                        bounds.extend(new google.maps.LatLng(value.latitude, value.longitude));
                    }
                });
                if (response.length > 1) {
                    map.fitBounds(bounds);
                } else if (response.length == 1) {
                    map.setCenter(new google.maps.LatLng(response[0].latitude, response[0].longitude));
                }
            });
        }  

        function init() {
            var defaultLatLng = new google.maps.LatLng(34.0983425, -118.3267434);  // Default to Hollywood, CA when no geolocation support
            if ( navigator.geolocation ) {
                function success(pos) {
                    // Location found, show map with these coordinates
                    drawMap(new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude));
                }
                function fail(error) {
                    drawMap(defaultLatLng);  // Failed to find location, show default map
                }
                // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
                navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy:true, timeout: 6000});
            } else {
                drawMap(defaultLatLng);  // No geolocation support, show default map
            }          
        };

        $( document ).ready(function() {
            $('#fileupload').fileupload({
                dataType: 'json',
                done: function (e, data) {

                    var width = Math.ceil($("#date").outerWidth());

                    $.each(data.result.imageURL, function (index, url) {
                        var img = $("<img />");
                        img.attr("id", "uploadedImage" + index);
                        img.addClass("uploadedImage");
                        img.attr("name", "uploadedImage");
                        img.attr("src", url);
                        img.attr("width", width);
                        $(img).insertAfter("#marker-submit");
                    });
                    
                    $("#map-page").trigger("pagecreate");
                }
            });

            $('#date').datetimepicker({lazyInit: true});

            $('#marker-submit').bind('click', function() {
                var imageArray = [];
                $.each($(".uploadedImage"), function(k, v) {
                    imageArray.push($(v).attr("src"));
                });
                createMarker(map, currentLatitude, currentLongitude, $("#date").val(), imageArray, $("#content").val());

                $.ajax({
                    url: "/api/addFootprint",
                    type: "post",
                    traditional: true,
                    data: {
                        date: $("#date").val(),
                        //brief: $("#brief").val(),
                        content: $("#content").val(),
                        latitude: currentLatitude,
                        longitude: currentLongitude,
                        image: imageArray
                    }, 
                    success: function(data) {
                    },
                    error: function(data) {
                    }
                });
                setCurrentLocation(0, 0);
            });
            
            loadGoogleMap("init");
            //init();

            $("#popup-timeline-panel").bind("click", function() {
                generateTimelineSlotListView("#timeline-slot-listview", function() {
                    $("#timeline-panel").panel("open");
                });
                return false;    
            })
        });
    </script>
</body>
</html>

